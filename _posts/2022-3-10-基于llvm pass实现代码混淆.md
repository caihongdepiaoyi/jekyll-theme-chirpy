---
title: 基于llvm pass实现代码混淆器
categories: [总目录, 日志]
tags: [日记]
---

# 实现方法

### 控制流平坦化

控制流平坦化：在不改变源代码的功能前提下，将C或C++代码中的if、while、for、do等控制语句转换成switch分支语句。这样做好处是可以模糊switch中case代码块之间的关系，从而增加分析难度。

1. 扫描函数中的所有基本块，并把基本块存储到vector容器中

2. 把入口块从vector容器中删除

3. 创建分发块和返回块，分发块用于根据case值跳转到各个基本块，每个基本块执行完会跳转到返回块，返回块会跳转会分发块
4. 在入口块和返回块的末尾添加到分发块的无条件跳转指令
5. 在入口块中创建并初始化一个switch变量，swVal，在调度块中插入switch指令，遍历vector容器中的每个基本块，并分配随机的case值，将其添加到switch指令的分支中
6. 编译每个基本块，在每个基本块末尾添加修改swVal变量的指令，便于返回分发块之后，能够正确执行下一个基本块
7. 删除基本块原来末尾的跳转
8. 修复PHI指令和逃逸变量，把PHI指令和逃逸变量转化为内存存取指令

# 混淆效果

![](E:\User\work\work2022上\dissertation\bin\image\屏幕截图 2022-03-09 122424.png)

![屏幕截图 2022-03-09 122538](E:\User\work\work2022上\dissertation\bin\image\屏幕截图 2022-03-09 122538.png)

![屏幕截图 2022-03-09 122648](E:\User\work\work2022上\dissertation\bin\image\屏幕截图 2022-03-09 122648.png)
